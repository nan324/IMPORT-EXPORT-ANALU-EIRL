<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analu Digital – Catálogo</title>
  <meta name="description" content="Catálogo de productos de Analu Digital -->> EN MANTENIMIENTO .">
  <style>
    * { box-sizing: border-box; }
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f6f7fb; color:#222;}
    header{background:#0f172a; color:white; padding:24px 16px; text-align:center; box-shadow: 0 2px 12px rgba(0,0,0,.15);}
    header h1{margin:0; font-size: clamp(22px, 4vw, 34px); letter-spacing:.5px;}
    header p{margin:6px 0 0; opacity:.85}
    .container{max-width:1200px; margin:24px auto; padding:0 16px;}
    .controls{display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px;}
    input, select{padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; outline:none; min-width:200px; background:white;}
    .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:16px;}
    .card{background:white; border-radius:16px; box-shadow:0 10px 24px rgba(2,6,23,.08); overflow:hidden; display:flex; flex-direction:column; transition: transform .15s ease, box-shadow .2s ease;}
    .card:hover{ transform: translateY(-2px); box-shadow:0 14px 28px rgba(2,6,23,.12);}
    .thumb{width:100%; aspect-ratio:1/1; object-fit:contain; background:#f9fafb;}
    .card-body{padding:12px 14px; display:flex; flex-direction:column; gap:6px;}
    .name{font-weight:600; line-height:1.25; font-size:15px;}
    .meta{font-size:13px; color:#6b7280;}
    .price{font-weight:800; margin-top:4px;}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px;}
    footer{padding:28px 16px; text-align:center; color:#6b7280; font-size:13px;}
    .hidden{display:none !important;}
    .debug{font-size:12px; color:#6b7280; margin-top:16px;}


    .avail{font-weight:600;font-size:12px;padding:2px 8px;border-radius:9999px}
    .avail.ok{background:#ecfdf5;color:#065f46}        /* verde */
    .avail.no{background:#fee2e2;color:#991b1b}        /* rojo  */

  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header>
    <h1>Analu Digital</h1>
    <p>Catálogo en MANTENIMIENTO</p>
  </header>

  <div class="container">
    <div class="controls">
      <input id="q" type="search" placeholder="Buscar por nombre...">
      <select id="cat">
        <option value="">Todas las categorías</option>
      </select>


      <select id="code" disabled>
  <option value="">Todos los códigos</option>
</select>


      
      
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="hidden">No se encontraron productos con esos filtros.</div>
    <div id="debug" class="debug"></div>
  </div>

  <footer>© <span id="year"></span> Analu Digital</footer>

<script>
  // === 1) NUEVO: tu API segura ===
  const API_URL = "https://script.google.com/macros/s/AKfycbwSFDcFdTET7ViMJdFMX_EmgBwICuCyouVHP07aOCEjjy_qT62JmRfHRfJKhS5dCgc/exec";
  const API_KEY = "MiClaveCatalogo2025_1972"; // <-- tu clave

// Prefijo de código  ->  Nombre visible para el cliente
const CODE_LABELS = {
  "HYS-SH": "Head & Shoulders",
  "HYS-AC": "Head & Shoulders",   // <- se junta con HYS-SH
  "SD-SH":  "Sedal",
  "SD-AC":  "Sedal"               // <- se junta con SD-SH
  "SD-CR":  "Sedal"
};

  // Normaliza claves (evita guiones/comillas raros) y obtiene el nombre de marca
function codeKey(s){
  return String(s).normalize('NFKC').replace(/[–—−]/g, '-').trim().toUpperCase();
}
function codeLabel(prefix){
  return CODE_LABELS[codeKey(prefix)] || prefix;
}



  // --- NUEVO: función para cargar con JSONP (evita CORS)
function fetchJSONP(url){
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const sep = url.includes('?') ? '&' : '?';
    s.src = `${url}${sep}callback=${cb}`;
    s.onerror = () => { delete window[cb]; s.remove(); reject(new Error('JSONP error')); };
    window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
    document.head.appendChild(s);
  });
}
  // Si en la hoja guardas ID o URL de Drive, esta función genera una URL válida para <img>
  function imgURL(val){
    if(!val) return "";
    val = String(val).trim().replace(/^["']|["']$/g,"").replace(/^\ufeff/, "");
    if (/^https?:\/\//.test(val)) {
      const m1 = val.match(/\/d\/([A-Za-z0-9_-]{10,})/);
      const m2 = val.match(/[?&]id=([A-Za-z0-9_-]{10,})/);
      val = (m1 && m1[1]) || (m2 && m2[1]) || val;
    }
    const m = String(val).match(/[A-Za-z0-9_-]{10,}/);
    const id = m ? m[0] : "";
    return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w1000` : "";
  }

  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const q = document.getElementById('q');
  const cat = document.getElementById('cat');
  const sortSel = document.getElementById('sort');
  const dbg = document.getElementById('debug');
  const state = { rows: [], filtered: [] };

  document.getElementById('year').textContent = new Date().getFullYear();

  function normalize(str){ return (str || "").toString().trim().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/^\ufeff/, ''); }

  function keyMatch(map, wanted){
    wanted = normalize(wanted);
    for (const k of Object.keys(map)){
      const nk = normalize(k);
      if (nk === wanted) return k;
    }
    for (const k of Object.keys(map)){
      const nk = normalize(k);
      if (nk.includes(wanted)) return k;
    }
    return null;
  }

  // Disponibilidad por stock
  function availability(s){
    const v = String(s ?? '').trim().toLowerCase();
    const num = parseFloat(v.replace(',', '.'));
    let ok = false;
    if (!isNaN(num)) { ok = num > 0; }
    else { ok = ['si','sí','disponible','available','true','ok'].includes(v); }
    return { text: ok ? 'Disponible' : 'No disponible', cls: ok ? 'ok' : 'no' };
  }


// --- Orden por código con sufijo numérico ---
// Acepta códigos con varios guiones, tomando el ÚLTIMO tramo como número.
// Ej: "HYS-SH-12" -> prefix: "HYS-SH", num: 12
function parseCodeLastNumber(code) {
  const txt = String(code || '').trim();
  const m = txt.match(/^(.+?)-(\d+)$/); // todo lo anterior al último guion es prefijo
  if (!m) return { prefix: txt.toUpperCase(), num: Number.POSITIVE_INFINITY };
  return { prefix: m[1].toUpperCase(), num: parseInt(m[2], 10) };
}
  
// Devuelve el prefijo (todo menos el último número). Ej: "HYS-SH-12" -> "HYS-SH"
function codePrefixOf(item){
  return parseCodeLastNumber(item.code).prefix || '';
}

// Construye las opciones del select #code según la categoría elegida
function renderCodePrefixesForCategory(categoryValue){
  const codeSel = document.getElementById('code');
  codeSel.innerHTML = '<option value="">Todos los códigos</option>';

  if (!categoryValue){
    codeSel.disabled = true;
    return;
  }

  // Agrupar por marca (label) todos los prefijos presentes en la categoría
  const groups = new Map(); // labelMarca -> Set<prefixes>
  for (const r of state.rows){
    if ((r.cat || '').toString().trim() !== categoryValue) continue;
    const pref = codePrefixOf(r);
    if (!pref) continue;
    const label = codeLabel(pref);   // ← juntamos por NOMBRE DE MARCA
    if (!groups.has(label)) groups.set(label, new Set());
    groups.get(label).add(pref);
  }

  // Llenar el select con UNA opción por marca
  const labels = Array.from(groups.keys())
    .sort((a,b) => a.localeCompare(b, 'es', {sensitivity:'base'}));

  for (const label of labels){
    const opt = document.createElement('option');
    opt.value = 'label:' + label;   // valor indica selección por marca
    opt.textContent = label;        // lo que ve el cliente
    codeSel.appendChild(opt);
  }

  codeSel.disabled = labels.length === 0;
}



  
// Ordena por: 1) prefijo (alfabético), 2) número final (asc)
function sortByCodePrefixThenNumber(arr) {
  return [...arr].sort((a, b) => {
    const A = parseCodeLastNumber(a.code);
    const B = parseCodeLastNumber(b.code);

    if (A.prefix < B.prefix) return -1;
    if (A.prefix > B.prefix) return 1;

    if (A.num < B.num) return -1;
    if (A.num > B.num) return 1;

    // desempate estable por texto completo del código
    const ac = String(a.code || '').toUpperCase();
    const bc = String(b.code || '').toUpperCase();
    return ac < bc ? -1 : ac > bc ? 1 : 0;
  });
}





  
  function renderCategories(rows){
  // 1) limpiar opciones previas (deja solo "Todas las categorías")
  while (cat.options.length > 1) cat.remove(1);

  // 2) deduplicar con normalize() para evitar "Aseo" vs "aseo"
  const map = new Map();
  for (const r of rows){
    const raw = (r.cat || '').toString().trim();
    if (!raw) continue;
    const key = normalize(raw);
    if (!map.has(key)) map.set(key, raw); // guarda la primera versión vista
  }

  // 3) ordenar alfabéticamente
  const cats = Array.from(map.values())
    .sort((a,b) => a.localeCompare(b, 'es', {sensitivity: 'base'}));

  // 4) agregar opciones únicas
  for (const c of cats){
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    cat.appendChild(opt);
  }
}


  function renderGrid(){
    grid.innerHTML = "";
    if (!state.filtered.length){
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    for (const r of state.filtered) {
      const url = imgURL(r.imgId);

      const card = document.createElement('div');
      card.className = 'card';

      const img = document.createElement('img');
      img.className = 'thumb';
      img.alt = 'foto';
      img.src = url;
      img.loading = 'lazy';
      img.decoding = 'async';
      img.onerror = function () {
        this.onerror = null;
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="600" height="600">
          <rect width="100%" height="100%" fill="#f3f4f6"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                fill="#9ca3af" font-family="Arial" font-size="22">Sin imagen</text>
        </svg>`;
        this.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
      };

      const body = document.createElement('div');
      body.className = 'card-body';
      const a = availability(r.stock);

      body.innerHTML = `
        <div class="name">${r.name || ''}</div>
        <div class="meta">Código: ${r.code || 'N/A'}</div>
        <div class="meta"><span class="badge">${r.cat || ''}</span></div>
        <div class="avail ${a.cls}">${a.text}</div>
      `;

      card.appendChild(img);
      card.appendChild(body);
      grid.appendChild(card);
    }
  }

function applyFilters(){
  const term = normalize(q.value);
  const c = cat.value;
  const codeSel = document.getElementById('code');
  const selection = codeSel ? codeSel.value : '';

  // 1) punto clave: INICIALIZAR arr
  let arr = [...state.rows];

  // 2) filtros básicos
  if (term) arr = arr.filter(r => normalize(r.name).includes(term));
  if (c)    arr = arr.filter(r => (r.cat || '').toString().trim() === c);

  // 3) filtro por marca/código (2.º combo)
  if (selection) {
    if (selection.startsWith('label:')) {
      const label = selection.slice(6); // nombre de la marca
      arr = arr.filter(r => codeLabel(codePrefixOf(r)) === label);
    } else {
      // compatibilidad si alguna opción fuese un prefijo directo
      arr = arr.filter(r => codePrefixOf(r) === selection);
    }
  }

  // 4) orden (si quitaste el select, queda fijo en 'code-asc')
  const s = (sortSel && sortSel.value) ? sortSel.value : 'code-asc';
  if (s === 'code-asc') {
    arr = sortByCodePrefixThenNumber(arr);
  } else {
    arr.sort((a,b)=>{
      if (s === 'name-asc')  return (a.name||'').localeCompare(b.name||'');
      if (s === 'name-desc') return (b.name||'').localeCompare(a.name||'');
      if (s === 'price-asc') return (+a.price||0) - (+b.price||0);
      if (s === 'price-desc')return (+b.price||0) - (+a.price||0);
      return 0;
    });
  }

  state.filtered = arr;
  renderGrid();
}



  // === 2) NUEVO: leer desde tu API en lugar del CSV
  async function fetchFromAPI({ q="", cat="all", sort="name-asc", page=0, pageSize=1000, inStock=0 } = {}) {
  const params = new URLSearchParams({ q, cat, sort, page, pageSize, inStock, key: API_KEY });
  const data = await fetchJSONP(`${API_URL}?${params.toString()}`);
  if (!data.ok) throw new Error(data.error || "Error API");
  return data.items;
}


  // Mapeo del JSON de la API -> estructura usada en la UI
  function mapItem(x){
    return {
      name:  x.nombre || '',
      code:  x.codigo || '',
      cat:   x.categoria || '',
      price: x.precio ?? '',
      stock: x.stock ?? '',
      imgId: x.imagen || ''   // puede ser ID o URL; imgURL() se encarga
    };
  }

  async function start(){
    try{
      const items = await fetchFromAPI({ pageSize: 1000 }); // trae todos (ajusta si tienes más)
      const mapped = items.map(mapItem).filter(r => r.name);

      // Quitar duplicados por nombre
      const unique = [];
      const seen = new Set();
      for (const r of mapped) {
        const key = (r.name || '').trim().toLowerCase();
        if (!seen.has(key)) { seen.add(key); unique.push(r); }
      }

      state.rows = unique;
dbg.textContent = "Productos cargados: " + state.rows.length;

// Render categorías (sin duplicados)
renderCategories(state.rows);

// Inicializar segundo select (códigos)
renderCodePrefixesForCategory(cat.value);

// Orden inicial
if (sortSel) { sortSel.value = 'code-asc'; }
applyFilters();

    } catch(err){
      grid.innerHTML = `<p>Error al cargar datos: ${err.message}</p>`;
    }
  }

  q.addEventListener('input', applyFilters);

cat.addEventListener('change', () => {
  renderCodePrefixesForCategory(cat.value); // llena el segundo select con prefijos
  applyFilters();
});

document.getElementById('code').addEventListener('change', applyFilters);

if (sortSel) sortSel.addEventListener('change', applyFilters);



  start();
</script>

</body>
</html>

